var structrRestUrl="/structr/rest/",buttonSelector="[data-structr-action]",altKey=!1,ctrlKey=!1,shiftKey=!1,eKey=!1;
$(function(){var b=new StructrApp(structrRestUrl);b.activateButtons(buttonSelector);$(document).trigger("structr-ready");b.hideNonEdit();$(window).on("keydown",function(c){c=c.which;16===c&&(shiftKey=!0);17===c&&(altKey=!0);18===c&&(ctrlKey=!0);69===c&&(eKey=!0)});$(window).on("keyup",function(c){c=c.which;16===c&&(shiftKey=!1);17===c&&(altKey=!1);18===c&&(ctrlKey=!1);69===c&&(eKey=!1)})});
function StructrApp(b){b&&(structrRestUrl=b);var c=this,h={},e={};this.edit=!1;this.data={};this.btnLabel=void 0;this.activateButtons=function(a){$(a).on("click",function(d){d.preventDefault();d.stopPropagation();var a=$(this);disableButton(a);c.btnLabel=c.btnLabel||a.text();var b=a.attr("data-structr-action").split(":");d=b[0];var m=b[1],b="true"===a.attr("data-structr-reload"),l=a.attr("data-structr-attributes"),n=(l?l.split(","):[]).map(function(a){return a.trim()}),l=a.attr("data-structr-id"),
p=$('[data-structr-id="'+l+'"]');if("create"===d){var k={};$.each(n,function(a,d){var c=$('[data-structr-name="'+d+'"]').val();k[d]=c&&"string"===typeof c?c.parseIfJSON():c});c.create(m,k,b,function(){enableButton(a)},function(){enableButton(a)})}else"edit"===d?c.editAction(a,l,n,b,function(){enableButton(a)},function(){enableButton(a)}):"cancel-edit"===d?c.cancelEditAction(a,l,n,b):"delete"===d?(d=c.field($('[data-structr-attr="name"]',p)),c.del(l,"true"===a.attr("data-structr-confirm"),b,d?d.val:
void 0)):(k={},$.each(n,function(a,d){var c=$('[data-structr-name="'+d+'"]').val();k[d]=c?c.parseIfJSON():c}),c.customAction(l,m,d,k,b,function(){enableButton(a)},function(){enableButton(a)}))})};this.editAction=function(a,d,b,g){var m=$('[data-structr-id="'+d+'"]');c.hideEdit(m);$.each(b,function(a,b){var f=$('[data-structr-attr="'+b+'"]',m);if(f.length){var k=c.field(f);k.id=d;c.data[d]||(c.data[d]={});c.data[d][b]=k.val;var g="a"===f[0].tagName.toLowerCase()?f:f.parent("a");if(g.length){var h=
g.attr("href");g.attr("href","").css({textDecoration:"none"}).on("click",function(){return!1})}var e=c.input(f);if(!e||!e.is("select")){a="Boolean"===k.type?checkbox(k.id,k.type,k.key,k.val):k.val&&-1!==k.val.indexOf("\n")?textarea(k.id,k.key,k.val):inputField(k.id,k.type,k.key,k.val);f.html(a);f=m.find('[data-structr-attr="'+k.key+'"]');e=c.input(f);e.css({fontFamily:"sans-serif"});resizeInput(e);g.length&&e.attr("data-structr-href",h);if("Boolean"!==k.type)e.on("keyup",function(a){c.checkInput(a,
c.field(e),$(this))});if("Date"===k.type)e.on("mouseup",function(a){a.preventDefault();a=$(this);a.datetimepicker({separator:"T",dateFormat:"yy-mm-dd",timeFormat:"HH:mm:ssz"});a.datetimepicker("show");a.off("mouseup")})}}});$('<button data-structr-action="save" data-structr-id="'+d+'">Save</button>').insertBefore(a);$('button[data-structr-action="save"][data-structr-id="'+d+'"]',m).on("click",function(){c.saveAction(a,d,b,g)});a.text("Cancel").attr("data-structr-action","cancel-edit");enableButton(a)};
this.saveAction=function(a,d,b,g){var m=$('[data-structr-id="'+d+'"]');$.each(b,function(a,b){var f=c.input($('[data-structr-attr="'+b+'"]',m)),f=c.field(f);if(b.contains(".")){delete c.data[d][b];var g=b.split("."),e=g[0],g=g[1];c.data[d][e]={};c.data[d][e][g]=f.val}else c.data[d][b]=f&&"Boolean"===f.type?!0===f.val?!0:!1:f&&f.val&&f.val.length?f.val:null});c.request("PUT",structrRestUrl+d,c.data[d],!1,"Successfully updated "+d,"Could not update "+d,function(){c.cancelEditAction(a,d,b,g)})};this.cancelEditAction=
function(a,d,b,g){if(g)window.location.reload();else{var m=$('[data-structr-id="'+d+'"]');$.each(b,function(a,b){var f=c.input($('[data-structr-attr="'+b+'"]',m));if(!f||!f.is("select")){var g=f.attr("data-structr-href"),e=f.parent("a");g&&e.length&&e.attr("href",g);f.replaceWith(c.data[d][b])}});$('button[data-structr-id="'+d+'"][data-structr-action="save"]').remove();a.text(c.btnLabel).attr("data-structr-action","edit");enableButton(a);c.hideNonEdit(m)}};this.input=function(a){a=$(a[0]);var d;if(a.is("input")||
a.is("textarea")||a.is("select"))return a;d=a.children("textarea");if(d.length)return d;d=a.children("input");if(d.length)return d;d=a.children("select");return d.length?d:null};this.field=function(a){if(a&&a.length){var d=a.attr("data-structr-type")||"String",b=a.attr("data-structr-id"),g=a.attr("data-structr-attr"),m=a.attr("data-structr-raw-value");if("Boolean"===d)a=a.is("input")?a.is(":checked"):"true"===a.text();else{var e=c.input(a);a=e?e.is("select")?$(":selected",e).attr("value"):m||e.val()&&
e.val().replace(/<br>/gi,"\n"):m||a.html().replace(/<br>/gi,"\n")}return{id:b,type:d,key:g,val:a,rawVal:m}}};this.getRelatedType=function(a,d,b){c.request("GET",structrRestUrl+"_schema",null,!1,null,null,function(a){})};this.create=function(a,d,b,g,e){console.log("Create",a,d,b,g,e);c.request("POST",structrRestUrl+a.toUnderscore(),d,b,"Successfully created new "+a,"Could not create "+a,g,e)};this.customAction=function(a,b,f,g,e,l,n){c.request("POST",structrRestUrl+(b?b.toUnderscore()+"/":"")+a+"/"+
f,g,e,"Successfully executed custom action "+f,"Could not execute custom action "+b,l,n)};this.request=function(a,b,f,g,e,l,n,h){f=JSON.stringify(f);$.ajax({type:a,url:b,data:f,contentType:"application/json; charset=utf-8",statusCode:{200:function(a){c.dialog("success",e);g?window.setTimeout(function(){window.location.reload()},200):n&&n(a)},201:function(a){c.dialog("success",e);g?window.setTimeout(function(){window.location.reload()},200):n&&n()},400:function(a,b,d){c.dialog("error",l+": "+a.responseText);
console.log(a,b,d);h&&h()},401:function(a,b,d){c.dialog("error",l+": "+a.responseText);console.log(a,b,d);h&&h()},403:function(a,b,d){c.dialog("error",l+": "+a.responseText);console.log(a,b,d);h&&h()},404:function(a,b,d){c.dialog("error",l+": "+a.responseText);console.log(a,b,d);h&&h(a)},422:function(a,b,d){c.dialog("error",l+": "+a.responseText);console.log(a,b,d);h&&h()},500:function(a,b,d){c.dialog("error",l+": "+a.responseText);console.log(a,b,d);h&&h()}}})};this.dialog=function(a,b){$('[data-structr-dialog="'+
a+'"]').addClass(a).html(b).show().delay(2E3).fadeOut(200)};this.add=function(a,b,c,g){var e=JSON.parse('{"'+g+'":[{"id":"'+a+'"}]}');$.ajax({url:structrRestUrl+c.toUnderscore()+"/"+b+"/ui",method:"GET",contentType:"application/json",statusCode:{200:function(a){void 0===a.result[g]?alert("Could not read related property\n\n    "+c+"."+g+"\n\nMake sure it is contained in the\nentity's ui view and readable via REST."):(a.result[g].length&&$.each(a.result[g],function(a,b){e[g].push({id:b.id})}),$.ajax({url:structrRestUrl+
c.toUnderscore()+"/"+b,method:"PUT",contentType:"application/json",data:JSON.stringify(e),statusCode:{200:function(){window.location.reload()},400:function(a){console.log(a)},422:function(a){console.log(a)}}}))}}})};this.remove=function(a,b,c,g){var e=JSON.parse('{"'+g+'":[]}');$.ajax({url:structrRestUrl+b+"/ui",method:"GET",contentType:"application/json",statusCode:{200:function(h){void 0===h.result[g]?alert("Could not read related property\n\n    "+c+"."+g+"\n\nMake sure it is contained in the\nentity's ui view and readable via REST."):
(h.result[g].length&&$.each(h.result[g],function(b,c){c.id!==a&&e[g].push({id:c.id})}),$.ajax({url:structrRestUrl+b,method:"PUT",contentType:"application/json",data:JSON.stringify(e),statusCode:{200:function(){window.location.reload()},400:function(a){console.log(a)},422:function(a){console.log(a)}}}))}}})};this.del=function(a,b,c,g){var e=!0;b&&(e=confirm("Are you sure to delete "+(g?g:a)+"?"));b&&!e||$.ajax({url:structrRestUrl+a,method:"DELETE",contentType:"application/json",statusCode:{200:function(){c&&
window.location.reload()}}})};this.save=function(a,c){var f={};f[a.key]=a.val;c&&c.html('<img src="/structr/img/al.gif"> Saving');$.ajax({url:b+a.id,method:"PUT",contentType:"application/json",data:JSON.stringify(f),statusCode:{200:function(){c&&c.text("Success!").remove()}}})};this.checkInput=function(a,b,f){a=a.which;isTextarea(f[0])?-1===f.val().indexOf("\n")&&(a=f.parent(),f.replaceWith(inputField(b.id,b.type,b.key,f.val())),f=c.input(a),f.on("keyup",function(a){c.checkInput(a,b,$(this))}),setCaretToEnd(f[0])):
13===a&&(a=f.parent(),f.replaceWith(textarea(b.id,b.key,f.val()+"\n")),f=c.input(a),f.on("keyup",function(a){c.checkInput(a,b,$(this))}),f.css({fontFamily:"sans-serif"}),setCaretToEnd(f[0]));resizeInput(f)};this.appendSaveButton=function(a,b,f,g,e){a.length&&$("#save_"+g+"_"+e).remove();f.after('<button class="save-button" id="save_'+g+"_"+e+'">Save</button>');$("#save_"+g+"_"+e).on("click",function(){var a=$(this),b=a.prev();c.save(c.field(b),a)})};this.hideEdit=function(a){$.each($("[data-structr-hide-id]",
a),function(){var a=$(this).attr("data-structr-hide-id");$(this).replaceWith(e[a]);delete e[a]});$.each($('[data-structr-hide="edit"]',a),function(a,b){var c=Math.floor(1E6*Math.random()+1);h[c]=$(b).clone(!0,!0);$(b).replaceWith('<div style="display:none;" data-structr-hide-id="'+c+'"></div>')});$(document).trigger("structr-edit")};this.hideNonEdit=function(a){void 0===a?$.each($('[data-structr-hide="non-edit"]'),function(a,b){var c=Math.floor(1E6*Math.random()+1);e[c]=$(b).clone(!0,!0);$(b).replaceWith('<div style="display:none;" data-structr-hide-id="'+
c+'"></div>')}):($.each($("[data-structr-hide-id]",a),function(){var a=$(this).attr("data-structr-hide-id");$(this).replaceWith(h[a]);delete e[a]}),$.each($('[data-structr-hide="non-edit"]',a),function(a,b){var c=Math.floor(1E6*Math.random()+1);e[c]=$(b).clone(!0,!0);$(b).replaceWith('<div style="display:none;" data-structr-hide-id="'+c+'"></div>')}))}}
function resizeInput(b){var c=b.val();if(c.length||!b.attr("size"))if(isTextarea(b[0])){var h=(c.match(/\n/g)||[]).length;b.attr("rows",h+2);c=c.split("\n").sort(function(b,a){return a.length-b.length})[0].length;b.attr("cols",c+1)}else b.attr("size",c.length+1)}function urlParam(b){b=b.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");return(b=(new RegExp("[\\?&]"+b+"=([^&#]*)")).exec(window.location.href))&&b.length?b[1]:""}String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)};
String.prototype.endsWith=function(b){return-1!==this.indexOf(b,this.length-b.length)};String.prototype.parseIfJSON=function(){if("{"===this.substring(0,1)){var b=this.replace(/'/g,'"');return JSON.parse(b)}return this};String.prototype.splitAndTitleize=function(b){var c=[];this.split(b).forEach(function(b){c.push(b.capitalize())});return c.join(" ")};String.prototype.toUnderscore=function(){return this.replace(/([A-Z])/g,function(b,c,h){return(0<h?"_":"")+b.toLowerCase()})};
"function"!==typeof String.prototype.contains&&(String.prototype.contains=function(b){return 0<this.indexOf(b)});function setCaretToEnd(b){var c=b.value.length;if(document.selection)b.focus(),b=document.selection.createRange(),b.moveStart("character",-c),b.moveStart("character",c),b.moveEnd("character",0),b.select();else if(b.selectionStart||0===b.selectionStart||"0"===b.selectionStart)b.selectionStart=c,b.selectionEnd=c,b.focus()}
function escapeTags(b){return b?b.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):b}function isTextarea(b){return"textarea"===b.nodeName.toLowerCase()}function textarea(b,c,h){return'<textarea class="structr-input-text">'+h+"</textarea>"}function inputField(b,c,h,e){b=e?e.length:c&&"Date"===c?25:h.length;return'<input class="structr-input-text" type="text" placeholder="'+(h?h.capitalize():"")+'" value="'+("null"===e?"":e)+'" size="'+b+'">'}
function field(b,c,h,e){return'<span type="text" data-structr-type="'+c+'" data-structr-attr="'+h+'">'+e+"</span>"}function checkbox(b,c,h,e){return'<input type="checkbox" data-structr-id="'+b+'" data-structr-type="'+c+'" '+(e?'checked="checked"':"")+'">'}function select(b,c,h,e){var a='<select data-structr-id="'+b+'">';$.each(e,function(b,c){a+="<option "+(c===h?"selected":"")+">"+c+"</option>"});return a+"</select>"}function enableButton(b){b.removeClass("disabled");b.removeAttr("disabled")}
function disableButton(b){b.addClass("disabled");b.attr("disabled","disabled")};